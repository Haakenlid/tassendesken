#include dokTools.jsxinc#include eksport.jsxinc#include prodsys.jsxinc#targetengine "session"try{	var dok = app.activeDocument;}catch(e){	exit();}var pdfSideDefault = false;var eksporterDefault = true;var endreSidetallDefault = false;var utgave = utgave();var nestefredag = nestefredag();dok.pages[0].appliedSection.sectionPrefix = "";if (!dok.saved){ // hvis dokumentet er "untitled"	alert("Kan ikke opprette PDF\rLagre dokumentet før du lager kan eksportere en pdf"); // setter inn sidetall og lager filnavn} else { // hvis siden er lagret og har filnavn 	lagPDF(dok); // eksporterer PDF}function lagPDF(dok) {	var myName = "UNI11VER"+nestefredag;	var myPath = dok.filePath.path+"/PDF/";	var PDFmappe = new Folder(myPath);	if (!PDFmappe.exists){ // finnes PDF-folderen?		PDFmappe.create();	}	if (dok.name.match(/UNI11VER/)){ //hvis dokumentet har et filnavn som inneholder "UNI11VER" så tar man utgangspunkt i det.		 myName = dok.name.slice(0,-10);	}	var eksportliste = [];		var myDialog = app.dialogs.add({name:"Eksporter til PDF",canCancel:true});	var myColumn = myDialog.dialogColumns.add();	myColumn.staticTexts.add({staticLabel:"Eksporter til mappe: "+myPath});		var dialogbokser = [];		for (var i = 0; i<dok.pages.length; i+=1){		var myPage=dok.pages[i];		var pageNumber = myPage.name;		if (pageNumber < 10){			pageNumber = "0"+pageNumber;			}		eksportliste.push({page: myPage, pageNumber: myPage.name, filnavn: myName+pageNumber+"000.pdf", path: myPath})	}		for (var i = 0; i<eksportliste.length; i+= 1){		var myRow=myColumn.dialogRows.add();		dialogbokser[i]=[];		dialogbokser[i][0] = myRow.checkboxControls.add({staticLabel:"side "+eksportliste[i].pageNumber, checkedState:pdfSideDefault});		dialogbokser[i][1] = myRow.textEditboxes.add({minWidth: 200, editContents: eksportliste[i].filnavn});			}		var tilProdsys = myColumn.dialogRows.add().checkboxControls.add({staticLabel:"Eksporter alle saker tilbake til prodsys?", checkedState:eksporterDefault});//	var mekkSiderLikevel = myColumn.dialogRows.add().checkboxControls.add({staticLabel:"Endre sidetall? (Endrer filnavnet og lagrer på ny)", checkedState:endreSidetallDefault});//~ 	incopyAssignment = myColumn.dialogRows.add().radiobuttonGroups.add(); //~ 	incopyAssignment.radiobuttonControls.add({staticLabel:"Lag incopyAssignment", checkedState:false});//~ 	incopyAssignment.radiobuttonControls.add({staticLabel:"Fjern incopyAssignment", checkedState:true});/*	nyeSidetall.onClick() = function(){		myDialog.close();		mekkSider(dok,utgave);	}*/	var myResult = myDialog.show();	if (myResult){//~ 		if (mekkSiderLikevel.checkedState){//~ 			var gammeltDok = new File(dok.fullName);//~ 			var nyttDok = mekkSider(dok,utgave);//~ 			if (nyttDok&&gammeltDok != nyttDok){//~ 				gammeltDok.remove();//~ 			}//~ 			exit();//~ 		}		if (dok.modified){ // lagrer dokumentet hvis det er gjort endringer			dok.save();		}		dok.sections.everyItem().sectionPrefix = "";		var myProgressBar = 	dokTools.progressBar("Lager PDF", "", dok.pages.length+1, false);		for (var i = 0; i<dialogbokser.length; i +=1){			if (dialogbokser[i][0].checkedState){				fjern = true;				minEksportSide = eksportliste[i];				myProgressBar.update("Eksporterer side "+minEksportSide.pageNumber+" til pdf\n"+minEksportSide.filnavn, i+1) 				minEksportSide.filnavn=dialogbokser[i][1].editContents;				minEksportSide.path = new File(myPath+minEksportSide.filnavn);				try{					eksportPDF (minEksportSide.pageNumber, minEksportSide.path);				}				catch(myError){ // pdf-fila er åpen i acrobat					var slettmeg = new File(myPath+"slettmeg.pdf");					if (slettmeg.exists){						slettmeg.remove();					}					minEksportSide.path.rename("slettmeg.pdf");					minEksportSide.path = new File(myPath+minEksportSide.filnavn);					eksportPDF (minEksportSide.pageNumber, minEksportSide.path);				}			}		}		myProgressBar.close();		if (tilProdsys.checkedState){			try{				eksportTilProdsys(dok);			} catch(e){				alert("Noe gikk feil med eksport til prodsys\r"+e);			}		}// FJERNET FORDI VI IKKE BRUKER INCOPY I ARBEIDSFLYTEN//~ 		if (incopyAssignment.selectedButton == 0){//~ 			lagAssignment();//~ 		}//~ 		if (incopyAssignment.selectedButton == 1){//~ 			fjernAssignment();//~ 		}	}		};	function eksportPDF(page,path){	var myOverflows, svar, 		myOverflows = dokTools.findOverflows(dok.pages.itemByName(page));	if (myOverflows.length>0){		myOverflows = myOverflows.join("\r\r");		myOverflows = myOverflows.length > 1000? myOverflows.substr (0,1000) + "[...]" : myOverflows;		svar = confirm ("Tekst flyter over, eksporter likevel?\rDet finnes tekst på side "+page+" som ikke kommer med:\r\r"+myOverflows)		if (svar == false){			return;		}	}		var myPDFpref = app.pdfExportPresets.itemByName("UNIVERSITAS");	app.pdfExportPreferences.viewPDF=false;	app.pdfExportPreferences.pageRange=page;	try{		dok.exportFile(ExportFormat.pdfType, path, false, myPDFpref,"",true);	} catch(e){		throw(e);	}}function utgave(){	var path = "/univ-desken/";	var nummer;	var myFile;	for (i = 50; i > 0; i--){		if (i<10){			nummer = "0"+i;		}		else {			nummer = i;		}		myFile = Folder (path+nummer);		if (myFile.exists) {			return i		}	}	return 0;}function nestefredag(){	var idag=new Date();	var ukedag=idag.getDay();	var fredag=new Date();	var nestefredag=new String();//~ 	if(ukedag>2){//~ 		ukedag=ukedag-7;//~ 	}	fredag.setDate(idag.getDate()+(5-ukedag));	nestefredag = fredag.getFullYear().toString().slice(2);	if(fredag.getMonth()+1<10){		nestefredag+="0"+(fredag.getMonth()+1);	}	else{		nestefredag+=fredag.getMonth()+1;	}	if(fredag.getDate()<10){		nestefredag+="0"+fredag.getDate();	}	else{		nestefredag+=fredag.getDate();	}	return nestefredag;}	